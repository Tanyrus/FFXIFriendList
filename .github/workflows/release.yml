name: Create Release

on:
  release:
    types: [created]
  push:
    tags:
      - 'v*'

jobs:
  build-and-release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Prepare release package
        run: |
          # Extract version from tag (e.g., v0.9.9 -> 0.9.9)
          VERSION=${GITHUB_REF#refs/tags/v}

          # Create temporary directory for release
          mkdir -p release

          # Copy addon files (excluding dev-only folders)
          rsync -av --exclude='docs/' \
                    --exclude='tests/' \
                    --exclude='scripts/' \
                    FFXIFriendList/ release/FFXIFriendList/

          # Verify the addon entry file exists
          echo "Addon entry file:"
          ls -la release/FFXIFriendList/FFXIFriendList.lua

          # Show version info
          echo "Version from addon:"
          grep "addon.version" release/FFXIFriendList/FFXIFriendList.lua

          # Create zip file with version-specific name
          cd release
          zip -r ../FFXIFriendList-${VERSION}.zip FFXIFriendList
          cd ..

          # Store the version for later steps
          echo "VERSION=${VERSION}" >> $GITHUB_ENV

          # Show package contents
          echo "Package contents:"
          unzip -l FFXIFriendList-${VERSION}.zip | head -50

      - name: Get release info
        id: get_release
        if: github.event_name == 'release'
        run: |
          echo "upload_url=${{ github.event.release.upload_url }}" >> $GITHUB_OUTPUT
          echo "release_name=${{ github.event.release.name }}" >> $GITHUB_OUTPUT

      - name: Upload release asset (on release event)
        if: github.event_name == 'release'
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.get_release.outputs.upload_url }}
          asset_path: ./FFXIFriendList-${{ env.VERSION }}.zip
          asset_name: FFXIFriendList-${{ env.VERSION }}.zip
          asset_content_type: application/zip

      - name: Create release from tag (on tag push)
        if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: |
            FFXIFriendList-${{ env.VERSION }}.zip
          name: FFXIFriendList v${{ env.VERSION }}
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

